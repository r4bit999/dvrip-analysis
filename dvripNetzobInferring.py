#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Netzob Script to infering Messages and Simulate a Login on the target device with a 4-way Handshake
# Copyright (C) 2020  Thomas Vogt
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

'''
#############################################
Pre Partitioned Messages with 4 byte blocks
#############################################
Message-Type | Payload-Length | ID  msg-num| unknown-1  | SessionID  | unknown-2  | SessionID  | unknown-3  | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
[[[ client <> server login 4 way Handshake ]]]
'a0050060'   | '00000000'     | 'c4a3af48' | '9956b6b4' | 'fa269dec' | '29d84afb' | '05020001' | '0000a1aa' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b0000078'   | '45000000'     | '010e0100' | '00000000' | '00000000' | '01000000' | '0600f900' | '00000002' | 'Realm:Login to 421592117ae7e3d0347d203dc8e04774\r\nRandom:668077460\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
'a0050060'   | '47000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '05020008' | '0000a1aa' | 'admin&&61976C2F7CD6D761C13B86CA2DB2647062016D052D7339CB058E877140CD1E7C'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
'b0000078'   | '00000000'     | '00080100' | '33000000' | 'f9ffff7f' | '01000000' | '0600f900' | '00050002' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 

'a4000000'   | '00000000'     | '01000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b4000078'   | '20000000'     | '01000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | b'\x02P\x01\x00\x00\x00\x02\x01\x02\x01\x00\x00\xe3\x07\x01\x16\x00\x00V3.2\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
'a4000000'   | '00000000'     | '07000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b4000078'   | '0f000000'     | '07000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '5C0726FPAGEC7C2'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
'a4000000'   | '00000000'     | '02000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b4000078'   | '20010000'     | '02000000' | '00000000' | '00000100' | '00000000' | '00000000' | '00000000' | b'\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
'f4000000'   | '55000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | 'TransactionID:1\r\nMethod:GetParameterValues\r\nParameterName:Dahua.Device.Decode.Cfg\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
'f6000000'   | '5b000000'     | '34020000' | '00000000' | '5b000000' | '00000000' | 'f9ffff7f' | '00000000' | '{ "id" : 564, "method" : "alarm.getAllInSlots", "params" : null, "session" : 2147483641 }\n\x00'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
'f6000000'   | '5c000000'     | '35030000' | '00000000' | '5c000000' | '00000000' | 'f9ffff7f' | '00000000' | '{ "id" : 821, "method" : "alarm.getAllOutSlots", "params" : null, "session" : 2147483641 }\n\x00'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'a4000000'   | '00000000'     | '1a000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'f4000078'   | '6b000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | 'TransactionID:1\r\nMethod:GetParameterValuesResponse\r\nParameterName:Dahua.Device.Decode.Cfg\r\nFaultCode:OK\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
'b4000078'   | '49030000'     | '1a000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | 'FTP:1:Record,Snap&&SMTP:1:AlarmText,AlarmSnap,HealthMail&&NTP:2:AdjustSysTime&&VideoCover:1:MutiCover&&AutoRegister:1:Login&&DriverTypeInfo:1:DriverType&&AutoMaintain:1:Reboot,DeleteFiles,ShutDown&&UPNP:1:SearchDevice&&DHCP:1:RequestIP&&STORE POSITION:1:FTP&&DefaultQuery:1:DQuery&&ImportantRecID:1:RECID&&SNMP:1:SNMPConfig&&ISCSI:1:ISCSIConfig&&PlayBackSpeedControl:1:SpeedUp&&ACFControl:1:ACF&&IPV6:1:IPV6Config&&DavinciModule:1:WorkSheetCFGApart,StandardGOP&&Dahua.a4.9:1:Login&&Dahua.Device.Record.General:1:General&&Log:1:PageForPageLog&&QueryURL:1:CONFIG&&SearchRecord:1:V3&&BackupVideoExtFormat:1:DAV,ASF&&Dahua_Config:1:Json,V3,MotionDetect_F6&&ProtocolFramework:1:V3_1&&DynamicReg:1:Allow0&&Multicast:1:SRMTP,SORT&&DynamicMultiConnecting:1:TalkSnd,AudioMonitor&&CommSniffer:1:CommATM&&NetSniffer:1:NetSniffer&&Net:1:RSA,A3,EncryptA3'                                                                                                                                                                                                                                                                                                                        
'f4000000'   | '59000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | 'TransactionID:4\r\nMethod:GetParameterValues\r\nParameterName:Dahua.Device.Record.General\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
'f6000078'   | '71000000'     | '35030000' | '01000000' | '71000000' | '00000000' | 'f9ffff7f' | '00000000' | '{"error":{"code":268632080,"message":""},"id":821,"params":{"outputs":null},"result":false,"session":2147483641}\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
'f4000078'   | 'f4000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | 'TransactionID:4\r\nMethod:GetParameterValuesResponse\r\nParameterName:Dahua.Device.Record.General\r\nFaultCode:OK\r\nIsGeneralRecord:0\r\nIsAlarmRecord:1\r\nIsMoveDetectRecord:1\r\nIsLocalStore:0\r\nIsRemoteStore:1\r\nIsRedunancyStore:0\r\nIsLocalurgentStore:0\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
'f6000078'   | '70000000'     | '34020000' | '01000000' | '70000000' | '00000000' | 'f9ffff7f' | '00000000' | '{"error":{"code":268632080,"message":""},"id":564,"params":{"inputs":null},"result":false,"session":2147483641}\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
'a1000000'   | '00000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b1000078'   | '00000000'     | '00000000' | '00f80002' | '00000000' | '00000000' | '00000000' | '00000000' | ''         

[[[ client logout request + server resposne ]]]
'0a000000'   | '00000000'     | 'f9ffff7f' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'0b010078'   | '00000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | '00000000' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'''

from netzob.all import *
import binascii
import time
import bitarray
from bitarray.util import *


import sys
import json
import ndjson	# pip3 install ndjson
import argparse
import copy
import _thread	
import hashlib
import inspect

from OpenSSL import crypto # pip3 install pyopenssl
from pwn import *	# https://github.com/Gallopsled/pwntools

# login credentials for the target device
username = "admin"
password = "1234567a"
HASH = ""
deviceSession = bitarray.bitarray()

#env_deviceSessionINT = Data(String(), name="env1")

#deviceSessionInt = Field(Data(Integer(),name="deviceSessionInt"))
deviceSessionInt = Field(name="deviceSessionInt", domain=Integer())

#Field(name="ID", domain=Raw(nbBytes=4))

################# code import from mscw
# From: https://github.com/haicen/DahuaHashCreator/blob/master/DahuaHash.py
def compressor(in_var, out):
    i=0
    j=0
	
    while i<len(in_var):
        # python 2.x (thanks to @davidak501)
        # out[j] = (ord(in_var[i]) + ord(in_var[i+1])) % 62;
        # python 3.x
        out[j] = (in_var[i] + in_var[i+1]) % 62
        if (out[j] < 10):
            out[j] += 48
        elif (out[j] < 36):
            out[j] += 55
        else:
            out[j] += 61        
        i=i+2
        j=j+1


def Dahua_Gen1_hash(passw):
	m = hashlib.md5()
	m.update(passw.encode("latin-1"))
	
	s=m.digest()
	crypt=[]
	for b in s:
		crypt.append(b)
	out2=['']*8
	compressor(crypt,out2)
	data=''.join([chr(a) for a in out2])
	return data

# Dahua DVRIP random MD5 password hash
#
def Dahua_DVRIP_md5_hash(Dahua_random, username, password):
	RANDOM_HASH = hashlib.md5((username + ':' + Dahua_random + ':' + Dahua_Gen1_hash(password)).encode('latin-1')).hexdigest().upper()
	return RANDOM_HASH

#
# Dahua random MD5 password hash
#
def Dahua_Gen2_md5_hash(Dahua_random, Dahua_realm, username, password):
	PWDDB_HASH = hashlib.md5((username + ':' + Dahua_realm + ':' + password).encode('latin-1')).hexdigest().upper()
	PASS = (username + ':' + Dahua_random + ':' + PWDDB_HASH).encode('latin-1')
	RANDOM_HASH = hashlib.md5(PASS).hexdigest().upper()
	return RANDOM_HASH

################# end of code import from mscw


def calculate_hash_callback(tmpdata):
    mytmpPayload = bitarray.bitarray(tmpdata).tobytes().decode('utf-8)')
    REALM = mytmpPayload.split('\r\n')[0].split(':')[1] if mytmpPayload.split('\r\n')[0].split(':')[0] == 'Realm' else False
    RANDOM = mytmpPayload.split('\r\n')[1].split(':')[1] if mytmpPayload.split('\r\n')[1].split(':')[0] == 'Random' else False
    global HASH
    HASH = username + '&&' + Dahua_Gen2_md5_hash(RANDOM, REALM, username, password) + Dahua_DVRIP_md5_hash(RANDOM, username, password)
    myHash = HASH
    ba = bitarray.bitarray()
    ba.frombytes(myHash.encode('utf-8'))
    return ba

# Update Session Variable
def updateSession(tmpdata):
    print("inupdatesession")
    #mytmpPayload = bitarray.bitarray(tmpdata).tobytes().decode('utf-8)')
    print("next")
    #print(mytmpPayload)
    print("sessionupdate")
    global deviceSession
    deviceSession = tmpdata
    global deviceSessionInt
    tmpint = int.from_bytes(deviceSession.tobytes(), byteorder='little')
    print("tmpint:")
    print(tmpint)
    print(str(tmpint))

    deviceSessionInt = Field(name="deviceSessionInt", domain=ASCII(str(tmpint)))
    #deviceSessionInt = int.from_bytes(deviceSession.tobytes(), byteorder='little')
    print("session-update-done\n")
    return tmpdata


# Update Session Variable
def checkSession(tmpdata):
    print("\nEntering checksession method()")
    print(tmpdata)
    #mytmpPayload = bitarray.bitarray(tmpdata).tobytes().decode('utf-8)')
    tmpint = int.from_bytes(deviceSession.tobytes(), byteorder='little')
    print("next")
    print(tmpint)
    print("next2")
    tmpintstr = str(tmpint)
    print(tmpintstr)
    #i = Integer(value=tmpint)
    print("end of-checksession-method\n")
    
    return int2ba(tmpint, length=32, endian='little')



#Importing pcap files, client <=> server communication
messages_session1 = PCAPImporter.readFile("/root/Master/PCAP/login-sdk-dahua-filter.pcap", importLayer=5).values()
messages_session2 = PCAPImporter.readFile("/root/Master/PCAP/windows-generated-traffix.pcap", importLayer=5).values()
messages_session3 = PCAPImporter.readFile("/root/Master/PCAP/console-login.pcap", importLayer=5).values()

#print("PCAP Importer done")


'''
for message in combMessage:
    print(message)
'''

# Defining overall vocabular
INPUT_VOCABULARY = []
OUTPUT_VOCABULARY = []
PROTOCOL_VOCABULARY = INPUT_VOCABULARY + OUTPUT_VOCABULARY


# Definne first symbol which catch all messages
UNKNOWN_SYMBOL = Symbol(name = "Unknown Symbol", messages=messages_session3)
UNKNOWN_SYMBOL.fields = [ 
    Field(name="Message-Type", domain=Raw(nbBytes=4)),      # validated, indicator what is happening
    Field(name="Payload-Length", domain=Raw(nbBytes=4)),    # validated
    Field(name="ID", domain=Raw(nbBytes=4)),                # unknown value, maybe ID, packet number
    Field(name="unknown-1", domain=Raw(nbBytes=4)),           # unknown 
    Field(name="EXPLEN", domain=Raw(nbBytes=4)),            # unknonwn value, maybe length
    Field(name="unknown-2", domain=Raw(nbBytes=4)),           # unknown
    Field(name="SessionID", domain=Raw(nbBytes=4)),         # session ID, unverified
    Field(name="unknown-3", domain=Raw(nbBytes=4)),           # unknown
    Field(name="Payload", domain=Raw(nbBytes=(0, 5000)))    # contains client or server payload
]



# Formating symbols for pretty print(symbol) hex-output, so we got data shown in the beginning of this script

UNKNOWN_SYMBOL.fields[0].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[1].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[2].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[3].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[4].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[5].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[6].addEncodingFunction(TypeEncodingFunction(HexaString))
UNKNOWN_SYMBOL.fields[7].addEncodingFunction(TypeEncodingFunction(HexaString))

print(UNKNOWN_SYMBOL)

## 1 # 1 # 1 # 1 # ###########################################################################################################
''' Client Login Initialization Symbol - FIRST ROW, represents the first message of the 4-way Login HS
Message-Type | Payload-Length | ID         | unknown-1  | EXPLEN     | unknown-2  | SessionID  | unknown-3  | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'a0050060'   | '00000000'     | 'c4a3af48' | '9956b6b4' | 'fa269dec' | '29d84afb' | '05020001' | '0000a1aa' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b0000078'   | '45000000'     | '010e0100' | '00000000' | '00000000' | '01000000' | '0600f900' | '00000002' | 'Realm:Login to 421592117ae7e3d0347d203dc8e04774\r\nRandom:668077460\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
'a0050060'   | '47000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '05020008' | '0000a1aa' | 'admin&&61976C2F7CD6D761C13B86CA2DB2647062016D052D7339CB058E877140CD1E7C'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
'b0000078'   | '00000000'     | '00080100' | '33000000' | 'f9ffff7f' | '01000000' | '0600f900' | '00050002' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'''

CLIENT_LOGIN_INIT_SYMBOL = Symbol(name = "Client Login Initialization Symbol", messages=messages_session1)
CLIENT_LOGIN_INIT_SYMBOL.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"a0050060")),   
    Field(name="Payload-Length",    domain=HexaString(b"00000000")),  
    Field(name="Command-ID",        domain=Raw(nbBytes=4)),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=Raw(nbBytes=4)),             # unknown 
    Field(name="EXPLEN",            domain=Raw(nbBytes=4)),             # unknonwn value, maybe length
    Field(name="unknown-2",         domain=Raw(nbBytes=4)),             # unknown
    Field(name="SessionID",         domain=HexaString(b"05020001")),    # session ID, unverified
    Field(name="unknown-3",         domain=HexaString(b"0000a1aa")),    # unknown, login-sequenzID
    # Field(name="Payload",           domain=Raw(nbBytes=(0, 0))) Payload field is empty
]
INPUT_VOCABULARY.append(CLIENT_LOGIN_INIT_SYMBOL)
# >>> In [21]: CLIENT_LOGIN_INIT_SYMBOL.specialize()
# <<< Out[21]: b'\xa0\x05\x00`\x00\x00\x00\x00M\x89\x99Wb\x00\xe0\xec\x83\x8c\x92;b=\xd6\x92\x05\x02\x00\x01\x00\x00\xa1\xaa'


## 2 # 2 # 2 # 2 # ###########################################################################################################
''' Server Login Challange Symbol -  SECOND ROW, represents the second message of the 4-way Login HS
Message-Type | Payload-Length | ID         | unknown-1  | EXPLEN     | unknown-2  | SessionID  | unknown-3  | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'a0050060'   | '00000000'     | 'c4a3af48' | '9956b6b4' | 'fa269dec' | '29d84afb' | '05020001' | '0000a1aa' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b0000078'   | '45000000'     | '010e0100' | '00000000' | '00000000' | '01000000' | '0600f900' | '00000002' | 'Realm:Login to 421592117ae7e3d0347d203dc8e04774\r\nRandom:668077460\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
'a0050060'   | '47000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '05020008' | '0000a1aa' | 'admin&&61976C2F7CD6D761C13B86CA2DB2647062016D052D7339CB058E877140CD1E7C'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
'b0000078'   | '00000000'     | '00080100' | '33000000' | 'f9ffff7f' | '01000000' | '0600f900' | '00050002' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
'''

SERVER_LOGIN_CHALLENGE = Symbol(name = "Server Login Challange Symbol", messages=messages_session1)
SERVER_LOGIN_CHALLENGE.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"b0000078")),   
    Field(name="Payload-Length",    domain=Raw(nbBytes=4)),             # we accept any length  
    Field(name="Command-ID",        domain=Raw(nbBytes=4)),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=HexaString(b"00000000")),             # unknown 
    Field(name="EXPLEN",            domain=HexaString(b"00000000")),    # this differs from second server login ;  unknonwn value, maybe length
    Field(name="unknown-2",         domain=Raw(nbBytes=4)),             # unknown
    Field(name="SessionID",         domain=Raw(nbBytes=4)),    # session ID, unverified
    Field(name="unknown-3",         domain=Raw(nbBytes=4)),    # unknown, login-sequenzID
    Field(name="Payload",           domain=Raw(nbBytes=(0, 8000))) 
]
OUTPUT_VOCABULARY.append(SERVER_LOGIN_CHALLENGE)


## 3 # 3 # 3 # 3 # ###########################################################################################################
''' Client Login Response Symbol - THIRD ROW, represents the third message of the 4-way Login HS
Message-Type | Payload-Length | ID         | unknown-1  | EXPLEN     | unknown-2  | SessionID  | unknown-3  | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'a0050060'   | '00000000'     | 'c4a3af48' | '9956b6b4' | 'fa269dec' | '29d84afb' | '05020001' | '0000a1aa' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b0000078'   | '45000000'     | '010e0100' | '00000000' | '00000000' | '01000000' | '0600f900' | '00000002' | 'Realm:Login to 421592117ae7e3d0347d203dc8e04774\r\nRandom:668077460\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
'a0050060'   | '47000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '05020008' | '0000a1aa' | 'admin&&61976C2F7CD6D761C13B86CA2DB2647062016D052D7339CB058E877140CD1E7C'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
'b0000078'   | '00000000'     | '00080100' | '33000000' | 'f9ffff7f' | '01000000' | '0600f900' | '00050002' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'''

CLIENT_LOGIN_RESPOSNE_SYMBOL = Symbol(name = "Client Login Response Symbol", messages=messages_session1)

# Fields for Payload Header
clrs_payload_field_1 = Field(name='Username',domain=ASCII(username) )
clrs_payload_field_2 = Field(name='tmp_delitimer', domain=ASCII("&&"))
clrs_payload_field_3 = Field(name='hash-calculation', domain=ASCII(nbChars=64))

CLIENT_LOGIN_RESPOSNE_SYMBOL.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"a0050060")),   
    Field(name="Payload-Length",    domain=HexaString(b"47000000")), # set to the length of the payload field which we have to generate and calculate             
    Field(name="Command-ID",        domain=HexaString(b"00000000")),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=HexaString(b"00000000")),             # unknown 
    Field(name="EXPLEN",            domain=HexaString(b"00000000")),    # this differs from second server login ;  unknonwn value, maybe length
    Field(name="unknown-2",         domain=HexaString(b"00000000")),             # unknown
    Field(name="SessionID",         domain=HexaString(b"05020008")),    # similar to first client message, session ID, unverified
    Field(name="unknown-3",         domain=HexaString(b"0000a1aa")),    # unknown, login-sequenzID
    Field(Value(SERVER_LOGIN_CHALLENGE.fields[8], operation = calculate_hash_callback), name="Payload"          ) 
]

# this was working, temporary
#CLIENT_LOGIN_RESPOSNE_SYMBOL.fields[8].fields = [clrs_payload_field_1, clrs_payload_field_2, clrs_payload_field_3]

#print(CLIENT_LOGIN_RESPOSNE_SYMBOL._str_debug())
#print(CLIENT_LOGIN_RESPOSNE_SYMBOL.specialize())

# looks good!
# In [72]: print(CLIENT_LOGIN_RESPOSNE_SYMBOL.specialize())
# b'\xa0\x05\x00`G\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x02\x00\x08\x00\x00\xa1\xaaadmin&&lULTMidh4pPttUjhzDtQCyFpI2HsBlPxkeJoiIp6SGNTMC20DnIMj9lQJkBhlpGL'

#CLIENT_LOGIN_RESPOSNE_SYMBOL.fields[8].fields[2].domain = ASCII("61976C2F7CD6D761C13B86CA2DB2647062016D052D7339CB058E877140CD1E7C")
# hash length => based on the length of username, other values have a static length, we use static because we only user admin currently
#CLIENT_LOGIN_RESPOSNE_SYMBOL.fields[1].domain = Size(HEADERS.fields[8:], dataType = Raw(nbBytes=4, unitSize=AbstractType.UNITSIZE_32))
#print(CLIENT_LOGIN_RESPOSNE_SYMBOL.specialize())

INPUT_VOCABULARY.append(CLIENT_LOGIN_RESPOSNE_SYMBOL)


## 4 # 4 # 4 # 4 # ###########################################################################################################
''' Server Login Response Symbol - FOURTH ROW, represents the fourth message of the 4-way Login HS
Message-Type | Payload-Length | ID         | unknown-1  | EXPLEN     | unknown-2  | SessionID  | unknown-3  | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'a0050060'   | '00000000'     | 'c4a3af48' | '9956b6b4' | 'fa269dec' | '29d84afb' | '05020001' | '0000a1aa' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
'b0000078'   | '45000000'     | '010e0100' | '00000000' | '00000000' | '01000000' | '0600f900' | '00000002' | 'Realm:Login to 421592117ae7e3d0347d203dc8e04774\r\nRandom:668077460\r\n\r\n'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
'a0050060'   | '47000000'     | '00000000' | '00000000' | '00000000' | '00000000' | '05020008' | '0000a1aa' | 'admin&&61976C2F7CD6D761C13B86CA2DB2647062016D052D7339CB058E877140CD1E7C'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
'b0000078'   | '00000000'     | '00080100' | '33000000' | 'f9ffff7f' | '01000000' | '0600f900' | '00050002' | ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
'''                                                      # sessionID

SERVER_LOGIN_RESPONSE = Symbol(name = "Server Login Response Symbol", messages=messages_session1)
SERVER_LOGIN_RESPONSE.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"b0000078")),   
    Field(name="Payload-Length",    domain=HexaString(b"00000000")),             # we accept any length  
    Field(name="Command-ID",        domain=Raw(nbBytes=4)),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=Raw(nbBytes=4)),             # unknown 
    Field(name="SessionID-RCV",     domain=Raw(nbBytes=4)),    # here we recieve the session ID in INT32 - Little Endian (DCBA)
    Field(name="unknown-2",         domain=Raw(nbBytes=4)),             # unknown
    Field(name="SessionID",         domain=Raw(nbBytes=4)),    # session ID, unverified
    Field(name="unknown-3",         domain=Raw(nbBytes=4)),    # unknown, login-sequenzID
    
   # Field(name="updater" , isPseudoField=True         ) 
]
#SERVER_LOGIN_RESPONSE.fields[8] = Field(Value(SERVER_LOGIN_RESPONSE.fields[4], operation = updateSession), name="pseudo", isPseudoField=True)
OUTPUT_VOCABULARY.append(SERVER_LOGIN_RESPONSE)



############################################################################################################
''' Query User Details
Message-Type | Payload-Length | ID         | unknown-1  | EXPLEN     | unknown-2  | SessionID  | unknown-3  | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
'f6000000'   | '95000000'     | '0b000000' | '00000000' | '95000000' | '00000000' | 'c4ffff7f' | '00000000' | '{"SID": 262146, "id": 11, "magic": "0x1234", "method": "console.runCmd", "params": {"command": "user -u"}, "object": 36738624, "session": 2147483588}'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
'f6000078'   | '1f0a0000'     | '05000000' | '00000000' | '1f0a0000' | '00000000' | 'c4ffff7f' | '00000000' | '{"callback":5,"id":5,"method":"client.notifyConsoleResult","params":{"SID":262146,"info":{"Count":4,"Data":["10:34:37|[Manager] [ver:Unknown] trace UserManager.cpp DumpUser 2559 tid:374 -------------\\n","10:34:37|[Manager] [ver:Unknown] trace UserManager.cpp DumpUser 2560 tid:374 User Info\\n","10:34:37|[Manager] [ver:Unknown] trace UserManager.cpp DumpUser 2561 tid:374 -------------\\n","10:34:37|[Manager] [ver:Unknown] info UserManager.cpp DumpUser 2568 tid:374 [\\n   {\\n      \\"Anonymous\\" : false,\\n      \\"AuthorityList\\" : [\\n         \\"AuthUserMag\\",\\n         \\"Monitor_01\\",\\n         \\"Replay_01\\",\\n         \\"AuthSysCfg\\",\\n         \\"AuthSysInfo\\",\\n         \\"AuthManuCtr\\",\\n         \\"AuthBackup\\",\\n         \\"AuthStoreCfg\\",\\n         \\"AuthEventCfg\\",\\n         \\"AuthNetCfg\\",\\n         \\"AuthPeripheral\\",\\n         \\"AuthAVParam\\",\\n         \\"AuthSecurity\\",\\n         \\"AuthMaintence\\"\\n      ],\\n      \\"Group\\" : \\"admin\\",\\n      \\"Id\\" : 1,\\n      \\"Memo\\" : \\"admin \'s account\\",\\n      \\"Name\\" : \\"admin\\",\\n      \\"Password\\" : \\"ABE8D77DDF4D5CD43CA5FB0F0B23A3C7\\",\\n      \\"PasswordModifiedTime\\" : \\"2000-01-01 00:01:59\\",\\n      \\"RandSalt\\" : \\"421592117ae7e3d0347d203dc8e04774\\",\\n      \\"Reserved\\" : true,\\n      \\"Sharable\\" : true\\n   },\\n   {\\n      \\"Anonymous\\" : false,\\n      \\"AuthorityList\\" : [ \\"Monitor_01\\" ],\\n      \\"Group\\" : \\"user\\",\\n      \\"Id\\" : 2,\\n      \\"Memo\\" : \\"anonymous account\\",\\n      \\"Name\\" : \\"anonymity\\",\\n      \\"Password\\" : \\"9BDC7C09871E7CC00B4D5CAB7D1B410F\\",\\n      \\"PasswordModifiedTime\\" : \\"2000-01-01 00:01:59\\",\\n      \\"RandSalt\\" : \\"421592117ae7e3d0347d203dc8e04774\\",\\n      \\"Reserved\\" : true,\\n      \\"Sharable\\" : true\\n   },\\n   {\\n      \\"Anonymous\\" : false,\\n      \\"AuthorityList\\" : [\\n         \\"AuthAVParam\\",\\n         \\"AuthBackup\\",\\n         \\"AuthEventCfg\\",\\n         \\"AuthMaintence\\",\\n         \\"AuthManuCtr\\",\\n         \\"AuthNetCfg\\",\\n         \\"AuthPeripheral\\",\\n         \\"AuthSecurity\\",\\n         \\"AuthStoreCfg\\",\\n         \\"AuthSysCfg\\",\\n         \\"AuthSysInfo\\",\\n         \\"AuthUserMag\\",\\n         \\"Monitor_01\\"\\n      ],\\n      \\"Group\\" : \\"admin\\",\\n      \\"Id\\" : 3,\\n      \\"Memo\\" : \\"\\",\\n      \\"ModifiedTime\\" : \\"\\",\\n      \\"Name\\" : \\"admin001\\",\\n      \\"Password\\" : \\"267B2EE2996A8D9E8A0B8C47238BBABD\\",\\n      \\"PasswordModifiedTime\\" : \\"2000-01-08 23:41:49\\",\\n      \\"RandSalt\\" : \\"421592117ae7e3d0347d203dc8e04774\\",\\n      \\"Reserved\\" : false,\\n      \\"Sharable\\" : true,\\n      \\"Type\\" : \\"\\"\\n   }\\n]\\n\\n"]}},"session":2147483588}\n'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
------------ | -------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
'''                                                      # sessionID

CLIENT_USER_DETAILS = Symbol(name = "Server User Details Symbol", messages=messages_session2)
CLIENT_USER_DETAILS.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"f6000000")),   
    Field(name="Payload-Length",    domain=HexaString(b"00000000")),             # we accept any length  
    Field(name="Command-ID",        domain=HexaString(b"0b000000")),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=HexaString(b"00000000")),             # unknown 
    Field(name="SessionID-RCV",     domain=HexaString(b"00000000")),    # here we recieve the session ID in INT32 - Little Endian (DCBA)
    Field(name="unknown-2",         domain=HexaString(b"00000000")),             # unknown
    Field(Value(SERVER_LOGIN_RESPONSE.fields[4]), name="SessionID"),            # session ID, unverified
    Field(name="unknown-3",         domain=HexaString(b"00000000")),    # unknown, login-sequenzID
#    Field(name="Payload",           domain=ASCII('{"SID": 262146, "id": 11, "magic": "0x1234", "method": "console.runCmd", "params": {"command": "user -u"}, "object": 36738624, "session": ' + Value(SERVER_LOGIN_RESPONSE.fields[4])._str_debug + '}')) 
    #Field(name="Payload",           domain=ASCII('{"SID": 262146, "id": 11, "magic": "0x1234", "method": "console.runCmd", "params": {"command": "user -u"}, "object": 36738624, "session": ' + Value(SERVER_LOGIN_RESPONSE.fields[4]).getValue() + '}')) 


]
INPUT_VOCABULARY.append(CLIENT_USER_DETAILS)


## test symbols


CLIENT_QUERY_SN = Symbol(name = "Client Query SN Symbol", messages=messages_session2)
CLIENT_QUERY_SN.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"a4000000")),   
    Field(name="Payload-Length",    domain=HexaString(b"00000000")),             # we accept any length  
    Field(name="Command-ID",        domain=HexaString(b"08000000")),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=HexaString(b"00000000")),             # unknown 
    Field(name="SessionID-RCV",     domain=HexaString(b"00000000")),    # here we recieve the session ID in INT32 - Little Endian (DCBA)
    Field(name="unknown-2",         domain=HexaString(b"00000000")),             # unknown
    Field(name="SessionID",         domain=HexaString(b"00000000")),
    Field(name="unknown-3",         domain=HexaString(b"00000000")),    # unknown, login-sequenzID
]
INPUT_VOCABULARY.append(CLIENT_QUERY_SN)

################ Keepalive Symbol, after first login

CLIENT_KEEPALIVE = Symbol(name = "Client Keepalive Symbol")
CLIENT_KEEPALIVE.fields = [ 
    Field(name="Message-Type",      domain=HexaString(b"f6000000")),   
    Field(name="Payload-Length",    domain=HexaString(b"7c000000")),             # we accept any length  
    Field(name="Command-ID",        domain=HexaString(b"06000000")),             # unknown value, maybe ID, packet number
    Field(name="unknown-1",         domain=HexaString(b"00000000")),             # unknown 
    Field(name="SessionID-RCV",     domain=HexaString(b"7c000000")),    # here we recieve the session ID in INT32 - Little Endian (DCBA)
    Field(name="unknown-2",         domain=HexaString(b"00000000")),             # unknown
    Field(Value(SERVER_LOGIN_RESPONSE.fields[4], operation = updateSession) ,name="SessionID"),
    Field(name="unknown-3",         domain=HexaString(b"00000000")),    # unknown, login-sequenzID
    Field(name="payload1",           domain=ASCII('{"method": "global.keepAlive", "magic": "0x1234", "params": {"timeout": 30, "active": true}, "id": 2, "session": ')), #2147483550}'))
    Field(Value(SERVER_LOGIN_RESPONSE.fields[4], operation=checkSession), name="tmpx"), #2147483550}'))
    #Field(name="p2",                domain=ASCII(str(int.from_bytes(deviceSession.tobytes(), byteorder='little')))), #2147483550}'))
    Field("}", name="p3") #2147483550}'))
]
INPUT_VOCABULARY.append(CLIENT_KEEPALIVE)


query_args = {
    "method":"global.keepAlive",
    "magic" : "0x1234",
    "params":{
        "timeout": 0,
        "active": True},
    "id": 2,
    "session": int.from_bytes(deviceSession.tobytes(), byteorder='little')}

print(json.dumps(query_args))


# int.from_bytes(deviceSession.tobytes(), byteorder='little')

# END OF INFERENCE SCRIPT #


#############################################################################################
#############################################################################################
#############################################################################################
# START OF CLIENT SIMULATION #

def simulateLogin():
    tcp_client = TCPClient(remoteIP='192.168.178.108', remotePort=37777)
    abstractLayer1 = AbstractionLayer(tcp_client, INPUT_VOCABULARY + OUTPUT_VOCABULARY)
    
    to_be_sent = [CLIENT_LOGIN_INIT_SYMBOL, CLIENT_LOGIN_RESPOSNE_SYMBOL, CLIENT_KEEPALIVE]
    abstractLayer1.openChannel()

    try:
        # Send Login #1
        mymemory = Memory()
        abstractLayer1.writeSymbol(CLIENT_LOGIN_INIT_SYMBOL)

        # Recv Login #2 (response)
        (received_symbol, received_data) = abstractLayer1.readSymbol()
        print(received_symbol.name)

        # Send Login #3 (+ hash calculation callback)
        abstractLayer1.writeSymbol(CLIENT_LOGIN_RESPOSNE_SYMBOL)

        # Recv Login #4 (response)
        (received_symbol, received_data) = abstractLayer1.readSymbol()
        print(received_symbol.name)
        (abstractedSymbol, structured_data) = Symbol.abstract(received_data, [SERVER_LOGIN_RESPONSE])
        print(structured_data)
        print(abstractedSymbol.name)
        #print("\n\nRecieved Session value:")
        #print(abstractLayer1.memory.getValue(CLIENT_LOGIN_RESPOSNE_SYMBOL.fields[4]))
        #global deviceSession
        #deviceSession = received_symbol._AbstractField__fields.list[4]._Field__domain.currentValue
        #print(received_symbol._AbstractField__fields.list[4]._Field__domain.currentValue)

        # Send KeepAlive
        abstractLayer1.writeSymbol(CLIENT_KEEPALIVE)

        # Recv Login #4 (response)
        # abstract received_data to symbol => memory access possible?
        # memory access of abstractlayer1?
        (received_symbol, received_data) = abstractLayer1.readSymbol()
        print("communication done")
        #Symbol.getValues(received_symbol) # <= ! self, class handling
        print(received_symbol.name)
        print(received_data)

        
    finally:
        abstractLayer1.closeChannel()

# session based SN query, version query??

# Print only when showing imported PCAP for analyzing
#print(UNKNOWN_SYMBOL)

# Run specific client simulation
simulateLogin() # teste keepalive mit aktualisierte sesionin global var

import struct
import math
print("\n\nfinisihed - global vars:")
print(HASH)
print(deviceSession)
print(HexaString(deviceSession))

### working!!!
print(int.from_bytes(deviceSession.tobytes(), byteorder='little'))

